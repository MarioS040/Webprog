const express = require('express');
const router = express.Router();
const Joi = require('joi');
const validateRequest = require('_middleware/validate-request');
const authorize = require('_middleware/authorize')
const userService = require('./user.service');

// routes

/*
Ablauf von User.controller und article.controller ist identisc aufgebaut, 
1. route wird mit get oder post aufgerufen.
2.Aufrufen der Funktionen. muss eine Route authentifiziert werden, da z.b. etwas in der Datenbank geändert wird,
    oder abgefragt wird, was nicht jeder ohne Authentifizierung sehen soll wird bei den entsprechenden Routen 
    die "authorize()" aufgerufen
3. in User.Service werden die ensprechenden Abfragen bzw. inserts in die Datenbank vorgenommen, diese returnen 
   wieder an users/article.controller.
*/

router.post('/authenticate', authenticateSchema, authenticate);
router.post('/register', registerSchema, register);
router.get('/', authorize(), getAll);
router.get('/current', authorize(), getCurrent);
router.get('/:id', authorize(), getById);
router.put('/:id', authorize(), updateSchema, update);
router.delete('/:id', authorize(), _delete);

module.exports = router;

function authenticateSchema(req, res, next) {
    const schema = Joi.object({
        username: Joi.string().required(),
        password: Joi.string().required()
    });
    validateRequest(req, next, schema);
}

function authenticate(req, res, next) {
    userService.authenticate(req.body)
        .then(user => res.json(user))
        .catch(next);
}

function registerSchema(req, res, next) {
    const schema = Joi.object({
        firstName: Joi.string().required(),
        lastName: Joi.string().required(),
        username: Joi.string().required(),
        username: Joi.string().required(),
        password: Joi.string().min(6).required()
    });
    validateRequest(req, next, schema);
}

function register(req, res, next) {
    //Variable yabeempl wird dazu verwendet, dass bei dem Registrierungs Vorgang
    //der Datenbank Eintrag yabeempl auf "false" gesettz wird, dass keiner die Berechtigung erlangen kann
    //über die Standard Registrierung die Artikel der Firma Yabe zu  löschen oder hochzuladen
    
    let yabeempl = {"yabeempl" : "false"}
    let complete = Object.assign(req.body, yabeempl)

    userService.create(complete)
        .then(() => res.json({ message: 'Registration successful' }))
        .catch(next);
}

function getAll(req, res, next) {
    userService.getAll()
        .then(users => res.json(users))
        .catch(next);
}

function getCurrent(req, res, next) {
    res.json(req.user);
}

function getById(req, res, next) {
    userService.getById(req.params.id)
        .then(user => res.json(user))
        .catch(next);
}

function updateSchema(req, res, next) {
    const schema = Joi.object({
        firstName: Joi.string().empty(''),
        lastName: Joi.string().empty(''),
        username: Joi.string().empty(''),
        password: Joi.string().min(6).empty('')
    });
    validateRequest(req, next, schema);
}

function update(req, res, next) {
    userService.update(req.params.id, req.body)
        .then(user => res.json(user))
        .catch(next);
}

function _delete(req, res, next) {
    userService.delete(req.params.id)
        .then(() => res.json({ message: 'User deleted successfully' }))
        .catch(next);
}